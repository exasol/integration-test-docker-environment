name: CD

on:
  push:
    tags:
      - '**'

jobs:

  check-tag-version-job:
    name: Check Release Tag
    uses: ./.github/workflows/check-release-tag.yml
    permissions:
      contents: read

  cd-job:
    needs: [ check-tag-version-job ]
    name: Continuous Delivery
    uses: ./.github/workflows/build-and-publish.yml
    permissions:
      contents: write
    secrets:
      PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}

  standalone-executable:
    name: Create a standalone linux executable
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: SCM Checkout
        uses: actions/checkout@v4

      - name: Setup Python & Poetry Environment
        uses: exasol/python-toolbox/.github/actions/python-environment@v1

      - name: Build standalone binary
        run: poetry run -- nox -s build-standalone-binary -- --executable-name "itde_linux_x86-64"

      - name: Upload to release
        run: gh release upload ${{ github.ref_name }} dist/itde_linux_x86-64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-docs:
    needs: [ cd-job ]
    name: Publish Documentation
    uses: ./.github/workflows/gh-pages.yml
    permissions:
      contents: read
      pages: write
      id-token: write
